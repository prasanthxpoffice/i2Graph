<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Mapper</title>
    <link rel="stylesheet" href="/libraries/jquery-ui/jquery-ui-1.13.3.min.css">
    <link rel="stylesheet" href="/libraries/free-jqgrid/css/ui.jqgrid.min.css">
    <link rel="stylesheet" href="/css/site.css">
  </head>
  <body>
    <div class="layout">
      <header>
        <h1>Mapper</h1>
        <span class="sub">Tools for preparing and loading data</span>
        <span class="hint">Use the sidebar to open a tool</span>
      </header>
      <aside>
        <div class="nav" id="nav">
          <div class="section">Data</div>
          <a href="mapper/datauploader/index.html" class="link">
            <span class="dot"></span>
            <span>Data Uploader (CSV)</span>
          </a>
          <div class="section">Graph</div>
          <a href="graph/Index.html" class="link">
            <span class="dot"></span>
            <span>Graph Viewer</span>
          </a>
        </div>
      </aside>
      <main>
        <div id="content" role="main" style="position:absolute;inset:0;overflow:auto;background:#fff;"></div>
      </main>
    </div>
    <script src="/libraries/jquery/jquery-3.7.1.min.js"></script>
    <script src="/libraries/jquery-ui/jquery-ui-1.13.3.min.js"></script>
    <script src="/libraries/free-jqgrid/js/jquery.jqgrid.min.js"></script>
    <script>
      (function(){
        const content = document.getElementById('content');
        const nav = document.getElementById('nav');

        function setActiveByUrl(url){
          nav.querySelectorAll('.link').forEach(a => a.classList.toggle('active', a.getAttribute('data-url') === url));
        }

        async function loadPage(url){
          const res = await fetch(url, { cache: 'no-store' });
          const html = await res.text();
          const doc = new DOMParser().parseFromString(html, 'text/html');
          const base = new URL(url, location.origin);
          // Ensure page styles from <head>
          const headLinks = Array.from(doc.querySelectorAll('head link[rel="stylesheet"][href]'));
          headLinks.forEach(l => {
            const href = l.getAttribute('href'); if (!href) return;
            const abs = new URL(href, base).pathname;
            if (![...document.styleSheets].some(s => s.href && (s.href.endsWith(abs) || s.href.endsWith(href)))){
              const n = document.createElement('link'); n.rel='stylesheet'; n.href = abs; document.head.appendChild(n);
            }
          });
          // Inject body markup
          content.innerHTML = doc.body ? doc.body.innerHTML : html;
          // Execute scripts (resolve relative src against page base)
          const scripts = Array.from(doc.querySelectorAll('script'));
          for (const s of scripts){
            const n = document.createElement('script');
            const type = s.getAttribute('type'); if (type) n.type = type;
            if (s.src) {
              const abs = new URL(s.getAttribute('src'), base).pathname;
              n.src = abs;
              await new Promise(r=>{ n.onload=r; n.onerror=r; document.body.appendChild(n); });
            } else {
              n.textContent = s.textContent || '';
              content.appendChild(n);
            }
          }
          // If loading Data Uploader, ensure jqGrid CSS is last for precedence
          if (url.includes('mapper/datauploader')){
            const ensureLast = (href) => {
              const link = Array.from(document.querySelectorAll('head link[rel="stylesheet"]')).find(x => x.getAttribute('href') === href);
              if (link){ link.parentNode.removeChild(link); }
              const n = document.createElement('link'); n.rel='stylesheet'; n.href=href; document.head.appendChild(n);
            };
            ensureLast('/libraries/jquery-ui/jquery-ui-1.13.3.min.css');
            ensureLast('/libraries/free-jqgrid/css/ui.jqgrid.min.css');
          }
        }

        nav.addEventListener('click', (e)=>{
          const a = e.target.closest('a.link'); if (!a) return; e.preventDefault();
          const url = a.getAttribute('data-url'); if (!url) return;
          setActiveByUrl(url); loadPage(url); history.replaceState(null,'',`#/${encodeURIComponent(url)}`);
        });

        function initial(){
          // Upgrade links to SPA behavior
          nav.querySelectorAll('a.link').forEach(a => { const href=a.getAttribute('href'); if (href){ a.setAttribute('data-url', href); a.removeAttribute('href'); }});
          const hash = location.hash && location.hash.startsWith('#/') ? decodeURIComponent(location.hash.slice(2)) : (nav.querySelector('a.link')?.getAttribute('data-url') || 'mapper/datauploader/index.html');
          setActiveByUrl(hash); loadPage(hash);
        }
        window.addEventListener('hashchange', () => {
          const hash = location.hash && location.hash.startsWith('#/') ? decodeURIComponent(location.hash.slice(2)) : null;
          if (hash) { setActiveByUrl(hash); loadPage(hash); }
        });
        window.addEventListener('load', initial, { once:true });
      })();
    </script>
  </body>
  </html>

